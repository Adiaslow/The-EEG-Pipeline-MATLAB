%{
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀⣤⣤⣤⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⢀⢄⣒⢏⣐⢐⢈⢀⠈⢀⢢⡀⢠⠈⢂⣫⢢⣤⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠃⣗⢤⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠐⠓⠊⠊⣄⠐⢠⢁⢈⠅⠂⢀⢈⠀⢀⢨⠘⣢⢐⠊⣯⣤⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢣⣹⣄⠀⠀⠀⣄⣄⣠⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠂⢄⢀⠀⠀⢠⠀⢀⠀⢀⢐⢠⢡⠡⡎⣯⡀⠀⢀⡠⢄⢒⠀⢉⢩⢩⠁⢁⠉⢠⢂⢤⣀⣀⣀⠀⠀⣇⢏⡄⠀⢀⣟⢮⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠠⣀⢀⢀⢀⠠⠄⢀⢈⢕⣵⠛⠉⢁⢀⢀⢐⢀⠈⠐⢀⠀⣀⢐⢀⣨⢂⠀⢀⢀⢈⢀⢈⢠⠈⢐⠐⠩⠻⣇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⢀⡠⠤⢀⠀⠠⢠⢤⣀⠀⠀⠀⠉⠀⠊⠮⣮⠃⢉⠔⢀⣰⣀⠠⢀⢠⢠⣈⠀⠠⠐⠠⢀⣿⣿⢏⠀⣀⠠⠐⣀⣠⣐⠠⢰⠀⣀⡀⢀⠀⢒⠀⠀⠀⠀⠀⠀⠀⠀
⠀⢀⢄⢈⠐⢈⢀⢀⠀⠐⡈⢀⢀⠠⠀⠈⢒⢄⠀⡄⢉⠀⡀⠀⠐⢀⢀⠠⡈⣾⣿⣷⢀⢪⢠⠀⠀⢐⢀⠁⢠⢀⢀⠀⢈⢘⣀⣀⠰⠤⢄⣐⠀⠀⣛⠏⠀⠀⠀⠀⠀⠀⠀⠀
⠊⢀⣠⢀⢀⢘⢀⠐⢀⠰⢀⢀⢀⠠⠀⢄⣈⢐⢠⠀⢨⢢⢈⢈⣂⢰⣞⢠⣈⠀⠐⠀⢀⠀⢀⢀⢀⠀⠀⢐⠴⠒⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢀⠀⢠⢀⢐⢀⢀⠀⢀⢀⢀⠨⠀⢐⠀⢀⢀⣀⢀⠠⢀⠀⢀⠀⠠⣀⢠⢀⠀⢠⠀⠈⢀⢀⠈⢀⣀⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢀⢀⢨⢠⢀⢨⠸⠰⢀⢐⠀⢀⢠⢊⠠⢠⢨⢘⢂⣐⠀⠀⢀⢐⠂⢐⠑⢀⠀⠀⠀⢀⠐⠠⢀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢀⠀⢠⠠⢀⣈⣈⣈⢀⠠⢈⠀⠀⣐⠈⢀⢈⠀⢠⣠⢀⠠⣀⠀⠀⢀⣢⢀⣀⠀⢈⠀⢀⢀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⣀⣈⠨⢸⢀⠀⢊⠀⠀⠀⠌⢀⠰⢀⠐⢀⢨⠈⢀⠊⠀⠈⠘⠘⠐⠠⢊⢘⠀⠠⢨⠐⠀⠰⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢠⢀⢠⢰⢀⢀⢀⠀⠀⡐⢀⢀⢈⢐⠀⢠⢠⠀⢀⢀⢀⢀⢀⢀⢀⠠⣀⠀⢀⠠⠀⢀⢠⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⢈⢀⠐⢐⢀⢠⠐⢀⢐⢊⠀⠀⢀⢀⢈⢁⣀⢠⠀⢈⠀⢀⠀⠀⢀⢀⠀⢀⢀⠀⠐⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣤⣄⣀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⣨⢀⢊⢠⢀⢀⢈⢐⠀⢀⠀⢀⠀⠈⢀⠀⢐⠀⠀⠀⢀⢀⢀⠀⢠⢰⢄⠀⠈⢀⠁⠀⢀⢁⢀⣂⣔⣦⣤⣀⠀⠀⠀⠀⠀⠀⠀⠈⠈⠐⠊⢼⠨⢁⢘⣯⢦⠀⠀⠀⠀⠀⠀⠀
⠀⠀⣀⢀⠀⠀⠀⠀⢀⠈⢠⡀⠐⢀⠀⠀⣈⢠⢠⣊⢀⠈⢀⢀⠂⠀⠑⢄⣀⢀⢈⣠⠬⠊⠁⠀⠁⠀⠉⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠪⣬⠎⣫⡄⠀⠀⠀⠀⠠
⠀⠂⠘⢰⢀⢠⢀⢀⢀⠈⢀⢀⠠⠀⢀⠐⡠⢘⠘⠂⠀⠔⠈⠀⠀⠀⠀⠀⠀⡞⢽⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⢤⣀⠒⢲⢒⢒⠒⢁⢀⣰⢀⣉⢂⠂⠂⣠⠠
⢀⡀⢀⠠⢈⠀⣈⠈⢄⠠⢨⣀⠈⢀⡀⠨⠤⠀⠈⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣯⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⠂⠁⠠⠘⢨⢐⢀⣀⠀⠈⢠⠐⠢⢿⠟⠀⢀⠈⡀⢊
⠀⠀⠈⢂⠠⢈⢀⢐⠀⠀⠀⠀⠠⠀⢻⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣤⢴⢲⢒⠠⠐⢡⣀⢐⢂⠰⢠⢐⠀⠙⠿⠋⠀⠀⠀⢂⢰⠤⠒⠈⠉⠀⠀
⣰⣈⢘⢂⢐⢀⠀⡀⠈⢀⢀⢀⠀⠐⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣔⣛⢐⢘⢀⢠⣀⠀⢀⣐⢀⢀⢐⠀⠀⢘⠀⢈⢀⠀⢈⠈⠄⠉⠀⠀⠀⠀⠀⠀⠀
⢈⠈⢀⠈⢀⠐⢀⣀⢀⢀⢈⢀⠀⢀⠠⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣖⢃⣈⢳⢡⢈⠀⢈⠠⢀⠀⠀⠠⢀⢊⢄⢐⢀⢀⢠⢠⡠⢀⡜⠀⠀⠀⠀⠀⠀⠀⠀⠀
⢣⢪⠨⠰⢐⢀⢀⠈⢐⣐⢈⠄⠢⢨⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣧⣃⢄⢀⣰⢢⠀⠀⢠⢠⠀⢀⣈⢀⠐⠨⢀⢀⢠⢈⠀⠈⢀⠰⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠈⠢⢈⠀⢈⠀⠐⢀⢀⠐⠐⠐⢀⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣏⣇⣊⣧⢐⠠⢰⠀⢀⢐⢀⢀⢀⢀⢀⠀⠈⡈⢐⠨⡀⢀⠀⠀⣠⣩⣤⡀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠈⢌⠀⠀⠀⠌⢠⢐⢐⠀⠐⢐⢂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠂⣁⢢⢊⠀⠠⢀⠈⢀⢀⠀⢢⠀⢐⢀⠨⢬⠐⠒⠈⠀⠀⠀⠈⣿⠉⠏⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠂⢀⡈⠈⠀⠈⢠⣀⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣇⢑⢘⣢⠠⢐⢀⡀⢐⢨⣄⢰⢀⢠⠀⠀⢀⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠈⢄⠀⢠⠀⠈⢀⠐⢈⣿⣤⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⣅⠀⠡⠢⢢⡤⠈⠀⠀⠉⡀⢀⠀⠨⢘⢹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠈⠒⠀⣨⣶⢿⣯⣯⣻⣻⣷⢯⣶⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠢⣀⣠⣤⡿⣶⣤⣤⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠒⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠉⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀
        TTTTTT  HH  HH  EEEEEE          EEEEEE  EEEEEE   GGGGG
          TT    HH  HH  EE              EE      EE      GG  
          TT    HHHHHH  EEEEEE          EEEEEE  EEEEEE  G  GGG  
          TT    HH  HH  EE              EE      EE      GG  GG
          TT    HH  HH  EEEEEE          EEEEEE  EEEEEE   GGG G

    PPPPPP  IIIIII  PPPPPP  EEEEEE  LL      IIIIII  NN  NN  EEEEEE
    PP  PP    II    PP  PP  EE      LL        II    NNN NN  EE
    PPPPPP    II    PPPPPP  EEEEEE  LL        II    NNNNNN  EEEEEE
    PP        II    PP      EE      LL        II    NN NNN  EE
    PP      IIIIII  PP      EEEEEE  LLLLLL  IIIIII  NN  NN  EEEEEE

**************************************************************************
*  Press the "Run" button under the "Editor" tab to start the pipeline. 
*  
**************************************************************************
%}

% Open EEGLAB
tic

fprintf( "\n" )
disp( "*********************************************************" )
disp( "*                    Starting EEGLAB                    *" )
disp( "*********************************************************" )
fprintf( "\n" )

% eeglab;

fprintf( "\n" )
    disp( strcat( "Execution Time = ", string( toc ), " seconds" ) )

preparation()

global CHANNEL_SIGNAL_AXES;
global EEG;
global EEG_FILE;
global EEG_FILE_PATH;
global FILE_PATH;
global FILE_TYPE;
global FULL_EEG_FILE_PATH;
global LOG_TEXT
global EEG_INFO_TEXT

disp( "*********************************************************" )
disp( "*               Starting The EEG Pipeline               *" )
disp( "*********************************************************" )
fprintf( "\n" )

gui = uifigure('Name', 'The EEG Pipeline',...
    'Position',[0 40 1920 1010],...
    'numberTitle', 'off');

tabGroup = uitabgroup(gui,...
    'Position', [10 10 1900 990]);

% Home Tab
homeTab = uitab(tabGroup,...
    'Title', 'Home');

%% Log Panel
logPanel = uipanel(homeTab,...
    'Title', 'Console Log',...
    'TitlePosition', 'centertop',...
    'Position', [1540 10 350 950]);

% Log Text
LOG_TEXT = uitextarea(logPanel,...
    'Editable', 'off',...
    'Position', [0 0 350 930]);

%% File Information Panel
fileInformationPanel = uipanel(homeTab,...
    'Title', 'File Information',...
    'TitlePosition', 'centertop',...
    'Position', [10 10 500 950]);

% EEG Information Log
EEG_INFO_TEXT = uitextarea(fileInformationPanel,...
    'Editable', 'off',...
    'Position', [10 10 480 730]);

% Client Code Field
clientCodeLabel = uilabel(fileInformationPanel,...
    'Position', [10 840 140 20]);

clientCodeLabel.Text = "Client Code";

clientCode = uieditfield(fileInformationPanel,...
    'text',...
    'Position', [350 840 140 20],...
    'Value', '- - - -');

% Date of EEG Field
dateOfEEGLabel = uilabel(fileInformationPanel,...
    'Position', [10 810 140 20]);

dateOfEEGLabel.Text = "Date of EEG";

dateOfEEG = uieditfield(fileInformationPanel,...
    'text',...
    'Position', [350 810 140 20],...
    'Value','mmddyyyy');

% Condition Field
conditionLabel = uilabel(fileInformationPanel,...
    'Position', [10 780 140 20]);

conditionLabel.Text = "Condition";

condition = uidropdown(fileInformationPanel,...
    'Position', [350 780 140 20],...
    'Items', {'Eyes Open','Eyes Closed'});

% Data Type Field
dataTypeLabel = uilabel(fileInformationPanel,...
    'Position', [10 750 140 20]);

dataTypeLabel.Text = "Data Type";

dataType = uidropdown(fileInformationPanel,...
    'Position', [350 750 140 20],...
    'Items', {'Continuous','Event Related Potentials'});

% EEG File Type
FILE_TYPE = uidropdown(fileInformationPanel,...
    'Position', [280 900 60 20],...
    'Items', {'.xdf', '.edf'});

% Load Data Button
loadDataLabel = uilabel(fileInformationPanel,...
    'Position', [10 900 200 20]);

loadDataLabel.Text = "/...";

loadDataButton = uibutton(fileInformationPanel,...
    'Position', [350 900 140 20],...
    'Text', 'Choose EEG File',...
    ButtonPushedFcn = @(loadDataButton,event) loadFile(loadDataLabel));

% Save Location Button
saveDataLabel = uilabel(fileInformationPanel,...
    'Position', [10 870 140 20]);

saveDataLabel.Text = "/...";

saveDataButton = uibutton(fileInformationPanel,...
    'Position', [350 870 140 20],...
    'Text', 'Choose Save Location',...
    ButtonPushedFcn = @(loadDataButton,event) saveFile(saveDataLabel));

%% Preprocessing Options Panel
preprocessingOptionsPanel = uipanel(homeTab,...
    'Title', 'Preprocessing Options',...
    'TitlePosition', 'centertop',...
    'Position', [520 10 500 470]);

%% Processing Options Panel
processingOptionsPanel = uipanel(homeTab,...
    'Title', 'Processing Options',...
    'TitlePosition', 'centertop',...
    'Position', [520 490 500 470]);

%% Presentation Options Panel
presentationOptionsPanel = uipanel(homeTab,...
    'Title', 'Presentation Options',...
    'TitlePosition', 'centertop',...
    'Position', [1030 490 500 470]);

%% Pipeline Options Panel
pipelineOptionsPanel = uipanel(homeTab,...
    'Title', 'Pipeline Options',...
    'TitlePosition', 'centertop',...
    'Position', [1030 10 500 470]);

%% Signal Tab
signalTab = uitab(tabGroup,...
    'Title', 'Channel Signal');

% Channel Signal Plot
CHANNEL_SIGNAL_AXES = axes(signalTab);

CHANNEL_SIGNAL_AXES.Position = [0.1 0.1 0.8 0.8];

CHANNEL_SIGNAL_AXES.Color = '#E4D96F';

CHANNEL_SIGNAL_AXES.YGrid = 'on';
CHANNEL_SIGNAL_AXES.XGrid = 'on';

CHANNEL_SIGNAL_AXES.YTick = 0:18;

CHANNEL_SIGNAL_AXES.YTickLabel = {'Fp1', 'Fp2',...
    'F3', 'F4',...
    'C3', 'C4',...
    'P3', 'P4',...
    'O1', 'O2',...
    'F7', 'F8',...
    'T3', 'T4',...
    'T5', 'T6',...
    'Fz', 'Cz', 'Pz'};

CHANNEL_SIGNAL_AXES.YLim = [0 19];

CHANNEL_SIGNAL_AXES.YDir = 'reverse';

% Plot Data Button
plotDataButton = uibutton(signalTab,...
    'Position', [10 10 140 20],...
    'Text', 'Plot Signal Data',...
    ButtonPushedFcn = @(loadDataButton,event) plotChannelSignal());


%% ICA Tab
tab3 = uitab(tabGroup,...
    'Title', 'ICA');

return;

%% Run Pipeline
pipeTic = tic;

fprintf( "\n" )
disp( "*********************************************************" )
disp( "*            Running Preprocessing Pipeline             *" )
disp( "*********************************************************" )
fprintf( "\n" )

% Set Paths and Create Directories
[ FILE_PATH, FILE_NAME , FILE_FULL ] = preparation;

% Load Data
EEG = initialization( FILE_TYPE, FILE_FULL );

% Set Channel Locations
EEG = setChanLocs( EEG );

% remove DC offset
[ EEG, origEEG ] = removeDC( EEG );

% Clean Data
EEG = cleanData( EEG, origEEG );

% Set Average Reference
[ EEG ] = setAveRef( EEG, FILE_PATH, FILE_NAME );

% Run ICA
runICA( EEG );

% Run AMICA
% runAMICA( EEG );

% Run Dipole Fitting
runDipoFit( EEG );

fprintf( "\n" )
disp( strcat( "Execution Time = ", string( toc( pipeTic ) ), ...
      ' seconds' ) )
  
% Button Functions

% Load Button
function loadFile(loadDataLabel)

    global EEG_FILE;
    global LOG_TEXT;
    
    LOG_TEXT.Value = [LOG_TEXT.Value; " "; "Loading EEG File..."];
    
    initialization();
    
    loadDataLabel.Text = EEG_FILE;
    
    LOG_TEXT.Value = [LOG_TEXT.Value; " "; strcat("Loaded File: ", EEG_FILE)];

end

% Save Button
function saveFile(saveDataLabel)
global LOG_TEXT;

    LOG_TEXT.Value = [LOG_TEXT.Value; " "; "Setting Save Location..."];
    
    SAVE_DIR = uigetdir('C:\');
    saveDataLabel.Text = SAVE_DIR;
    
    LOG_TEXT.Value = [LOG_TEXT.Value; " "; strcat("Save Location: ", SAVE_DIR)];
end

% Plot Channel Signal
function plotChannelSignal()
    global CHANNEL_SIGNAL_AXES;
    global EEG;
    data = EEG.data;
    
    plot(0:256, data(1,1:2121), ...
         0:256, data(2,1:2121), ...
         0:256, data(3,1:2121), ...
         0:256, data(4,1:2121), ...
         0:256, data(5,1:2121), ...
         0:256, data(6,1:2121), ...
         0:256, data(7,1:2121), ...
         0:256, data(8,1:2121), 'Parent', CHANNEL_SIGNAL_AXES);
end
